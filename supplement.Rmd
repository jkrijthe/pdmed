---
title: "Supplementary Material"
output:
  word_document: default
  pdf_document: default
  html_document: default
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(dpi = 1200)
knitr::opts_chunk$set(fig.width=8)
library(tidyverse)
library(broom)
library(knitr)
```

# Methodology 

## PPMI cohort
PPMI is an observational, longitudinal, multicenter study designed to establish a comprehensive set of clinical, imaging and biosample data that can be used to define biomarkers of PD progression. The PPMI cohort used for our study contained data from 423 recently diagnosed PD patients (15). Broad inclusion criteria consisted of 1) the presence of an asymmetric resting tremor, asymmetric bradykinesia or two of bradykinesia, resting tremor and rigidity; 2) diagnosis of PD for two years or less and not taking PD medications at screening; and 3) deficit consistent with PD on SPECT imaging. Patients were expected not to require PD medication within at least six months from the baseline measurement, however patients were retained in the study and continued treatment if this was required before six months of follow-up.
All patients were assessed at the time of screening, at baseline (within 45 days of the screening visit), and every three to six months thereafter until a follow-up of 96 months. During each visit the investigator assessed a wide range of clinical measures and registered whether the patient used PD medication (yes/no) and, if so, which type of PD medication the patient used (multiple categories: levodopa, dopamine agonists, other, or any combination of those). Further information on the specific type of medication was described as free text in a medication log, from which the levodopa equivalent daily dose (LEDD) was derived

## Statistical approach
```{tikz dag,fig.ext="png",fig.width=3, fig.cap="Figure 1S: Directed Acyclic Graph of an idealized version of our causal model. L represents the set of covariates and outcomes (MDS-UPDRS scores, MoCA, MSE-ADL, etc.) and T represents the treatment indicator. In addition, we assume there are background variables (age, sex, education, time since diagnosis) that may influence both treatment decisions and the covariates in L, and the full history of treatment decisions may influence the current disease state (not shown, except for the last node)."}
\usetikzlibrary{positioning,shapes.geometric}

\begin{tikzpicture}[%
    ->,
    shorten >=2pt,
    >=stealth,
    node distance=1cm,thick,
    noname/.style={%
      circle,
      thick,
      minimum width=2em,
      minimum height=2em,
      draw
    }
  ]
    \node[noname] (1)                                             {$L_0$};
    \node[noname] (2) [right=of 1]                                {$L_1$};
    \node[noname] (3) [right=of 2] {$L_2$};
    \node[noname] (4) [right=of 3] {$L_3$};
\node[noname] (5) [right=of 4] {$L_4$};
    \node[noname] (6) [below=of 2]                                 {$T_1$};
    \node[noname] (7) [below=of 3]                                {$T_2$};
    \node[noname] (8) [below=of 4]              {$T_3$};
\node[noname] (9) [below=of 5]              {$T_4$};

    \path (1) edge                   node {} (2)
          (2) edge                   node {} (3)
          (3) edge                   node {} (4)
          (4) edge                   node {} (5)
          (6) edge                   node {} (7)
(7) edge                   node {} (8)
(8) edge                   node {} (9)
          (1) edge                   node {} (6)
(2) edge                   node {} (7)
(3) edge                   node {} (8)
(4) edge                   node {} (9)
          (6) edge                   node {} (2)
(7) edge                   node {} (3)
(8) edge                   node {} (4)
(9) edge                   node {} (5)
(6) edge [looseness=2.1, out=-30, in=-20] node {} (5)
(7) edge [looseness=1.9, out=-40, in=-30] node {} (5)
(8) edge [looseness=1.8, out=-50, in=-40] node {} (5);
  \end{tikzpicture}
```

A simplified version of the underlying causal model we assume in this work is shown in Figure 1S. L in this figure denotes the time-varying confounders at each stage. These are formed by patient characteristics at each visit, and we assume they are adequately captured by the MDS-UPDRS part scores, MoCA and MSE-ADL in addition to the background characteristics of the patient: Age, Sex, Years of Education, disease duration and history of cardiovascular disease. An important insight from this model is that merely correcting for baseline measurements and characteristics is not enough to estimate the causal effect of intervening on the length of therapy in the first two years. Failing to properly adjust for the patient characteristics at each treatment decision could, for instance, improperly attribute longer therapy with bad outcomes, simply because the groups of patients that started medication therapy earlier, already had a more advanced state of the disease when the decision to start medication therapy was made. This confounding effect is known as time-varying confounding. The inverse probability of treatment weighting (IPTW) and parametric g-formula methods used in this work offer a  way to adjust for this time-varying confounding, either by reweighting patients in such a way that in the reweighted sample the chance of receiving each treatment no longer depends on the covariates at each stage, or by modelling and simulating disease trajectories under all possible treatment assignments for each patient.

## IPTW models

In IPTW, different weights are assigned to different patients to correct for the fact that the probability of starting treatment is not equal for each patient, like in a randomized experiment, but is influenced by the current disease state. Weighting patients differently is a way of equalizing these probabilities in the observational data to estimate what would have happened if the treatment initiation was properly randomized.
To find the weights, at each visit we estimate the prior probability of starting treatment for those that have not started yet, which will be used to stabilize the weights. We then estimate the probability of starting treatment for those that have not started yet given the untransformed covariates (age, sex, years of education, disease duration, a binary indicator for history of cardiovascular disease, MDS-UPDRS part I, II and III scores, MSE-ADL scores and, if available, MoCA score) of only the previous visit, using a linear logistic regression model. Note that we do not pool the data across visits, which allows the model to be different for the different visits.

We divide the prior of the observed decision (started vs. not-started) by the probability of the observed decision given by this logistic regression model. By multiplying these weights for the different time-points, we get a final weight that is used for estimating the working marginal structural model. 
For censoring in the IPTW models, we use the same procedure as for the treatment weights, and multiply the censoring weight by the weight given by the treatment models to get an overall weight which we use in the working marginal structural model.

In the working marginal structural model (MSM), we use a linear model of the time on treatment. To avoid a mismatch between the continuous time treatment information and the discrete time confounding adjustments in our models, we define the time on treatment as the number of treatment periods the patient is recorded to be using PD medication, multiplied by the length of the time periods (0.5 year). In other words, we define it to be $0.5 \sum_{i=1}^4 t_i$, rather than the precise length of the treatment recorded in the study. In most analyses, in the working MSM, we adjust for the outcome measured at baseline (indicated here as "Baseline Adjusted"). In this supplement, we also report results when adjusting for all baseline variables, not just the particular outcome of interest (indicated by "Baseline Adjusted All"), and with and without adjustment for censoring using inverse probability of censoring weighting (indicated by "Censoring"). We also show results when adjusting for outcome at baseline and the Levodopa Equivalent Daily Dose of the patient at the time of the outcome measurement (indicated using "LEDD"). While this latter model may seem to be sensible to adjust for the long duration response of medication on the measurement, the causal interpretation of these results is not straightforward, since LEDD is likely influenced by the treatment decision whose effect we are trying to estimate. 
Finally, we use a linear regression model both for the continuous as well as for the dichotomous outcomes, which allows for both a uniform implementation of the models and presentation of the results. For the dichotomous outcomes, a logistic regression model would have been a sensible alternative choice.


## Parametric g-formula models
When using the parametric g-formula, the goal was to estimate the effect of an intervention by constructing a model of disease progression over time, and we then used this model to simulate the effect of different interventions on the outcomes, starting from the observed values at baseline. We constructed models for the confounders and outcomes at each visit, based on data from the previous visit and the patient’s treatment status, using linear regression models. We allow for treatments earlier than the current visit to influence the prediction of the next observation. These links are not shown in the causal model in Figure 1S, but are reflected in the fitted model which contain the observed values of the covariates at the previous available time-point (and the baseline measurements, for the predictions at the final time-point) and all available previous treatment decisions. The variables that are included are treatment status, age, sex, years of education, disease duration, an indicator for the presence of cardiovascular disease, MDS-UPDRS part I, II and III scores, MSE-ADL and, for yearly measurements, MoCA score. To take the correlations between the time-varying covariates at each time point into account, we iteratively add the variables for the current time-point to the models, in the order just mentioned. For instance, the model to generate the current MDS-UPDRS part I score only contains variables from the previous visit, while the model for the current part II score includes the current part I score, and the model for the part III score includes the current part I and part II scores. Using these models, for each patient from the subpopulation of interest, for each of the 5 possible treatment decisions decisions (starting therapy at year 0, 0.5, 1, 1.5 or 2), we simulate 100 trajectories for the covariates and outcomes, which, in the analysis where we consider 5 options for the treatment length and the whole sample at baseline, gives (416\*5\*100=208000) trajectories. 
We use the same working marginal structural model on these simulated outcomes as used in the IPTW method to generate the final estimates.

## Missing data
Since the efficiency of the estimators of some of our models improved by having access to complete observations at all time points under consideration, we imputed missing values. For the imputation of PD treatment status, we used the procedure described below in ‘Missing treatment status’. For both the outcome measures and potential confounders, we imputed missing data as follows. If two consecutive measurements were missing we considered a patient as having dropped out of the study, and measurements at future time points were considered missing. If a single measurement was missing, we used the previous and next measurements to impute the missing values using a regression model estimated based on the observations of other patients that had no missing data at that time point. 

## Missing treatment status
If the information on treatment status was missing in a visit we instead use whether or not there was a positive LEDD in the medication log. For the use of levodopa specifically, we imputed as follows: if a patient used levodopa at the previous visit, we assumed the patient had started treatment and a positive levodopa status was imputed; if the patient had a negative levodopa status at the subsequent visit, we assumed the patient had not started levodopa and a negative levodopa status was imputed; if the levodopa status was negative at the previous visit but positive in the next visit, we assumed the patient also used levodopa at the current visit.


# Supplementary Results

```{r load-data}
load("data/results-summary.RData")
df_varying <- readRDS("data/df_varying.rds")
df_constant <- readRDS("data/df_constant.rds")
df_last <- readRDS("data/df_last.rds")
```

```{r}
# treat_length <- df_varying %>% 
#   left_join(df_constant,by="id") %>% 
#   group_by(id) %>% 
#   summarize(years_treatment=sum(PDMEDYN)/2)

# df_varying %>% 
#   filter(!(id %in% pats_stopped_PDMEDYN)) %>% 
#   left_join(df_constant,by="id") %>% 
#   left_join(treat_length,by="id") %>% 
#   filter(time==4) %>% 
#   group_by(years_treatment) %>% 
#   summarize(mean(MDS_UPDRS_III_off,na.rm=TRUE),sd(MDS_UPDRS_III_off,na.rm=TRUE),mean(MDS_UPDRS_III_other),sd(MDS_UPDRS_III_other),n(),sum(is.na(MDS_UPDRS_III_off)),sum(!is.na(MDS_UPDRS_III_off))) %>% 
#   ungroup
# 
# 
# df_varying %>% 
#   filter(!(id %in% pats_stopped_PDMEDYN)) %>% 
#   left_join(df_constant,by="id") %>% 
#   left_join(treat_length,by="id") %>% 
#   filter(time==4) %>% 
#   lm(MDS_UPDRS_III_off~years_treatment,data=.) %>% summary
# 
# df_varying %>% 
#   filter(!(id %in% pats_stopped_PDMEDYN)) %>% 
#   left_join(df_constant,by="id") %>% 
#   left_join(treat_length,by="id") %>% 
#   filter(time==4) %>% 
#   filter(years_treatment!=0.0) %>% 
#   lm(MDS_UPDRS_III_off~years_treatment,data=.) %>% summary
# 
# (19+98+24+14)
# (19+98+24+14+58)
```


## Table 1S. Descriptives
```{r descriptives}
treat_length <- df_varying %>% 
  left_join(df_constant,by="id") %>% 
  group_by(id) %>% 
  summarize(years_treatment=sum(PDMEDYN)/2)


dbl_in_table <- function(x) {
  if (all(is.na(x))) {
    ""
  }
  else if (any(is.na(x))) {
    sprintf("%1.1f (%1.1f), NA:%d",mean(x,na.rm=TRUE), sd(x,na.rm=TRUE),sum(is.na(x)))
  } else {
   sprintf("%1.1f (%1.1f)",mean(x), sd(x))
  }
}

lg_in_table <- function(x) {
  sprintf("%1.2f",mean(x,na.rm=TRUE))
}


df_varying %>% 
  filter(!(id %in% pats_stopped_PDMEDYN)) %>% 
  left_join(df_constant,by="id") %>% 
  left_join(treat_length,by="id") %>% 
  filter(time==0) %>% 
  left_join(df_last %>% select(id,starts_with("LEDD")), by="id") %>% 
  group_by(years_treatment) %>% 
  summarize(n=n(),
            `Age (Years)`=dbl_in_table(Age), 
            `Gender (% Men)`=lg_in_table(Sex=="Male"),
            `Education (Years)`=dbl_in_table(Education),
            `Disease Duration (Years)`=dbl_in_table(Duration),
            `MDS-UPDRS I`=dbl_in_table(MDS_UPDRS_I),
            `MDS-UPDRS II`=dbl_in_table(MDS_UPDRS_II),
            `MDS-UPDRS III`=dbl_in_table(MDS_UPDRS_III_other),
            MoCA=dbl_in_table(MoCA),
            `MSE-ADL`=dbl_in_table(MSEADLG),
            `SCOPA-AUT`=dbl_in_table(SCOPA_AUT),
            `QUIP-S (% any)`=lg_in_table(QUIP>0),
            `LEDD at 2 years`=dbl_in_table(LEDD_year2),
            `LEDD at 3 years`=dbl_in_table(LEDD_year3),
            `LEDD at 4 years`=dbl_in_table(LEDD_year4)) %>% 
  gather(var,value,-years_treatment) %>% 
  mutate(var=fct_inorder(var),
         years_treatment=fct_explicit_na(factor(years_treatment),na_level="Censored")) %>% 
  spread(years_treatment,value) %>% 
  rename(`Treatment Length`=var) %>% 
  kable(caption="Table 1S. Baseline characteristics for groups of different Parkinson Medication duration during the first two years since the start of the study. For continuous measures, we show the mean (standard deviation). For dichotomous measures, we show the proportion. Treatment Length indicates the number of years of PD medication treatment received by each group during the first 2 years since the start of the study, where Censored refers to the group of patients for whom no complete follow-up was available for the first two years. NA indicates number of missing values.")
```
```{r}
# treat_length <- df_varying %>% 
#   left_join(df_constant,by="id") %>% 
#   group_by(id) %>% 
#   summarize(years_treatment=sum(ONLDOPA)/2)
# 
# df_varying %>% 
#   filter(!(id %in% pats_stopped_onldopa)) %>% 
#   left_join(df_constant,by="id") %>% 
#   left_join(treat_length,by="id") %>% 
#   filter(time==0) %>% 
#   left_join(df_last %>% select(id,starts_with("LEDD")), by="id") %>% 
#   group_by(years_treatment) %>% 
#   summarize(n=n()) %>% 
# ungroup 
```


## Table 2S. Medication types

```{r}
df_varying %>% 
  filter(!(id %in% pats_stopped_PDMEDYN)) %>% 
  left_join(df_constant,by="id") %>% 
  left_join(treat_length,by="id") %>% 
  filter(time==4) %>% 
  #filter(PD_MED_USE==0,years_treatment==0.5)
  filter(!is.na(years_treatment)) %>% 
  filter(years_treatment>0) %>% 
  count(years_treatment, PD_MED_USE) %>% 
  #summarize(n=sum(n))
  complete(years_treatment,PD_MED_USE, fill=list(n=0)) %>% 
  group_by(years_treatment) %>% 
  mutate(m=n,n=n/sum(n)) %>% 
  ungroup %>% 
  mutate(PD_MED_USE=factor(PD_MED_USE,levels=0:7,
                    labels=c("Missing","Lv","Ag","Other","Lv+Other","Lv+Ag","Ag+Other","Lv+Ag+Other"))) %>% 
  mutate(PD_MED_USE=fct_explicit_na(PD_MED_USE)) %>% 
  select(-m) %>% spread(PD_MED_USE,n) %>% 
  na.omit %>% 
  rename(`Years Treatment`=years_treatment) %>% 
  knitr::kable(digits=2, caption="Table 2S. Distribution of types of medication use for patients in the different groups at year 2, according to questions answered by the investigator. Lv: levodopa; Ag: agonist.")
```


```{r}
# Starting medication:
# df_varying %>% 
#   filter(!(id %in% pats_stopped_PDMEDYN)) %>% 
#   left_join(df_constant,by="id") %>% 
#   left_join(treat_length,by="id") %>% 
#   group_by(id) %>% 
#   mutate(start=(PDMEDYN & !lag(PDMEDYN))) %>% 
#   ungroup %>% 
#   filter(start) %>% 
#   #count(time,years_treatment)
#   #filter(years_treatment==0.5,time==1)
#   #count(time,years_treatment) 
#   count(years_treatment,PD_MED_USE) %>%
#   complete(years_treatment,PD_MED_USE, fill=list(n=0)) %>% 
#   group_by(years_treatment) %>% 
#   mutate(m=n,n=n/sum(n)) %>% 
#   ungroup %>% 
#   mutate(PD_MED_USE=factor(PD_MED_USE,levels=0:7,
#                     labels=c("None","Lv","Ag","Other","Lv+Other","Lv+Ag","Ag+Other","Lv+Ag+Other"))) %>% 
#   mutate(PD_MED_USE=fct_explicit_na(PD_MED_USE)) %>% 
#   select(-m) %>% spread(PD_MED_USE,n) %>% 
#   na.omit %>% 
#   rename(`Years Treatment`=years_treatment) %>% 
#   knitr::kable(digits=2, caption="Table 2S. Starting medication for patients in the different groups according to questions answered by the investigator. None: no medication; Lv: levodopa; Ag: agonist. None indicates a discrepancy between the two survey forms: the patient is indicated as having started Parkinson medication, but the type of medication is registered as none.")

# my_ids <- df_varying %>%
#   filter(!(id %in% pats_stopped_PDMEDYN)) %>%
#   left_join(df_constant,by="id") %>%
#   left_join(treat_length,by="id") %>%
#   filter(years_treatment==0.5, time==4) %>%
#   #filter(is.na(PD_MED_USE)) %>%
#   filter(PD_MED_USE==0) %>% 
#   .$id
# 
# my_ids <- df_varying %>%
#   filter(!(id %in% pats_stopped_PDMEDYN)) %>%
#   left_join(df_constant,by="id") %>%
#   left_join(treat_length,by="id") %>%
#   group_by(id) %>%
#   mutate(start=(PDMEDYN & !lag(PDMEDYN))) %>%
#   ungroup %>%
#   filter(start) %>%
#   filter(PD_MED_USE==0) %>%
#   .$id
# 
# 
# df_varying %>% filter(id %in% my_ids) %>% filter(time==1) %>% View()
# 
# mds_3 %>% 
#   left_join(pd_med_use) %>% 
#   filter(PATNO %in% my_ids) %>% 
#   filter(PD_MED_USE==0) %>% 
#   filter(is.na(PDMEDYN) | PDMEDYN==1) %>% 
#   select(PATNO,EVENT_ID,PD_MED_USE,PDMEDYN,ONLDOPA,ONDOPAG,ONOTHER)

```

```{r results="asis", eval=FALSE}
#Examples of "other" PD medication
my_ids <- df_varying %>%
  filter(!(id %in% pats_stopped_PDMEDYN)) %>%
  left_join(df_constant,by="id") %>%
  left_join(treat_length,by="id") %>%
  filter(years_treatment==2, time==1) %>%
  #filter(is.na(PD_MED_USE)) %>% 
  filter(PD_MED_USE==3) %>%
  .$id

load("data/data.Rdata")
conmedpd <- conmed %>% filter(DISMED==1)
get_medications <- function(id, event="V02") {
  idate <- sig %>% filter(PATNO==id,EVENT_ID %in% c(event)) %>% arrange(EVENT_ID) %>% .$INFODT %>% .[[1]]
  
  conmedpd %>%
    filter(PATNO==id,
           is.na(STARTDT) | STARTDT<idate,
           is.na(STOPDT) | STOPDT>=idate)
}

#map_dfr(my_ids, get_medications, event="V02") %>% .$WHODRUG %>% unique
```



```{r eval=FALSE}
ids <- treat_length %>% filter(years_treatment==2) %>% .$id
df_med <- map_dfr(ids, get_medications, event="V02")
#length(ids)
dfuse2 <- df_med %>% count(WHODRUG) %>% mutate(perc=n/length(ids))

ids <- treat_length %>% filter(years_treatment==1.5) %>% .$id
df_med <- map_dfr(ids, get_medications, event="V04")
#length(ids)
dfuse15 <- df_med %>% count(WHODRUG) %>% mutate(perc=n/length(ids))


ids <- treat_length %>% filter(years_treatment==1) %>% .$id
df_med <- map_dfr(ids, get_medications, event="V05")
#length(ids)
dfuse1 <- df_med %>% count(WHODRUG) %>% mutate(perc=n/length(ids))

ids <- treat_length %>% filter(years_treatment==0.5) %>% .$id
df_med <- map_dfr(ids, get_medications, event="V06")
#length(ids)
dfuse05 <- df_med %>% count(WHODRUG) %>% mutate(perc=n/length(ids))

bind_rows("2"=dfuse2,"1.5"=dfuse15,"1"=dfuse1,"0.5"=dfuse05,.id = "Treatment") %>% 
  select(-n) %>% 
  spread(Treatment,perc,fill = 0) %>% arrange(desc(`1.5`)) %>% 
  rename(Medication=WHODRUG) %>% 
  mutate(Medication=str_to_title(Medication)) %>% 
  kable(digits = 2, caption="Table ?: Medication used during the first visit where the patients indicated that they used PD medication, according to the concomitant medication log. Numbers indicate what fraction of the patients used that medication in each group (0.5 year, 1 year, 1.5 year and 2 years of using PD medication in the first two years of the disease).")
```

```{r}
plot_bootstrap <- function(df_res, df_boot) {
  df_res %>% 
    left_join(df_boot,by = c("Outcome", "Model", "Year", "form")) %>% 
    mutate(Model=fct_rev(fct_inorder(Model))) %>% 
    ggplot(aes(x=estimate,y=Model,color=Model)) +
    geom_vline(aes(xintercept=0))+
    geom_point(na.rm=TRUE) +
    geom_segment(aes(x=estimate-2*sd,xend=estimate+2*sd,yend=Model),alpha=0.6,na.rm=TRUE) +
    theme_bw() +
    theme(text=element_text(family="sans"), 
          legend.position="none",
          panel.grid.major = element_line(linetype = 2,size=0.2),
          strip.background = element_rect(fill="white")) +
    ylab("") +xlab("") +
    facet_grid(Year~Outcome,labeller = labeller(Year = label_both, Outcome = label_value), scales="free_x") +
    theme(strip.placement = "outside",text=element_text(family="Lato")) +
    NULL#coord_cartesian(xlim=c(-10,10))
}
```


```{r}
process_results <- function(.x) {
  .x %>% 
    filter(term %in% c("I((treatment + treatment_lag1 + treatment_lag2 + treatment_lag3)/2)",
                       "I((treatment_lag1 + treatment_lag2 + treatment_lag3) * 2/3)")) %>% 
    filter(Model %in% c("Naive_msms","Naive_msms_adj","Naive_msms_adj_full",
                        "Censoring_msms_adj","Censoring_msms_adj_full","IPW_msms_adj","IPW_msms_adj_full","IPW_msms_adj_ledd","gformula_msms_adj")) %>% 
    mutate(Model=recode(Model,!!!c(`Naive_msms`="Naive",`Naive_msms_adj`="Baseline Adjusted",`Naive_msms_adj_full`="Baseline Adjusted All",
                                   `Censoring_msms_adj`="Baseline + Censoring", `Censoring_msms_adj_full`="Baseline All + Censoring",
                                   `IPW_msms_adj`="Baseline + IPTW",`IPW_msms_adj_full`=" Baseline All + IPTW", `IPW_msms_adj_ledd`="IPTW + LEDD", `gformula_msms_adj`="g-formula")
    )) %>% 
    filter(str_detect(Outcome,"MDS_UPDRS")|Outcome=="MoCA"|Outcome=="MSEADLG"|Outcome=="SCOPA_AUT") %>% 
    filter(Outcome!="MDS_UPDRS_III_other") %>% 
    mutate(Outcome=str_replace(Outcome,"_off","")) %>% 
    mutate(Outcome=str_replace_all(Outcome,"_"," ")) %>% 
    mutate(Outcome=str_replace_all(Outcome,"MDS UPDRS","MDS-UPDRS"))
}
```


## Figure 2S. MDS-UPDRS I, II, III, MoCA, MSEADL, SCOPA-AUT – Any PD medication - Only starters
```{r fig.asp=0.5, fig.cap="Figure 2S: Effect of a year of PD treatment (any medication) during the first two years of follow-up (estimated using only those patients who were using medication at the time of the outcome measurement). Effect on the score of different outcomes measured at year 2, 3 and 4."}
plot_bootstrap(
  full_results_PDMEDYN_started %>% process_results,
  bs_pdmedyn_started %>% process_results
) 
```

## Figure 3S. MDS-UPDRS I, II, III, MoCA, MSEADL, SCOPA-AUT – Any PD medication - Whole population
```{r fig.asp=0.5, fig.cap="Figure 3S. Effect of a year of PD treatment (any medication) during the first two years of follow-up (extrapolated to the whole study population). Effect on the score of different outcomes measured at year 2, 3 and 4. "}
plot_bootstrap(
  full_results_PDMEDYN_extra %>% process_results,
  bs_pdmedyn_extra %>% process_results
)
```

## Figure 4S. MDS-UPDRS I, II, III, MoCA, MSEADL, SCOPA-AUT – Only levodopa - Only starters
```{r fig.asp=0.5, fig.cap="Figure 4S: Effect of a year of PD treatment (exclusively levodopa) during the first two years of follow-up (estimated using only those patients who used levodopa exclusively during the first two years). Effect on the score of different outcomes measured at year 2, 3 and 4."}
plot_bootstrap(
  full_results_onldopa_levoonly %>% process_results,
  bs_onldopa_levoonly %>% process_results
)
```


```{r}
process_results_aux <- function(.x) {
  .x %>% 
    filter(term %in% c("I((treatment + treatment_lag1 + treatment_lag2 + treatment_lag3)/2)",
                       "I((treatment_lag1 + treatment_lag2 + treatment_lag3) * 2/3)")) %>% 
    # filter(Model %in% c("Naive_msms","Naive_msms","Naive_msms_adj_full",
    #                     "IPW_msms","IPW_msms_adj_full","IPW_msms_adj_ledd","gformula_msms")) %>% 
    mutate(Model=recode(Model,!!!c(`Naive_msms`="Naive",`Naive_msms_adj`="Baseline Adjusted",`Naive_msms_adj_full`="Baseline Adjusted All",
                                   `Censoring_msms`="Censoring", `Censoring_msms_adj`="Baseline + Censoring", `Censoring_msms_adj_full`="Baseline All + Censoring",
                                   `IPW_msms`="IPTW", `IPW_msms_adj`="Baseline + IPTW",`IPW_msms_adj_full`=" Baseline All + IPTW", `IPW_msms_adj_ledd`="IPTW + LEDD", `gformula_msms_adj`="g-formula")
    )) %>%
    mutate(Outcome=recode(Outcome,!!!c(`NP4OFF`="Motor fluctuations",`NP4WDYSK`="Presence of dyskinesias",`QUIP8`="QUIP sum", `QUIPany`="QUIP any")
    )) %>%
    filter(!(str_detect(Outcome,"MDS_UPDRS")|Outcome=="MoCA"|Outcome=="MSEADLG")) %>% 
    filter(Outcome!="QUIP") %>% filter(Outcome!="SCOPA_AUT")
}
```

## Figure 5S. Dyskinesias, motor fluctuations, QUIP – Any PD medication - Only starters

```{r fig.asp=0.4, fig.width=9, fig.cap="Figure 5S: Effect of a year of PD treatment (any medication) during the first two years of follow-up (estimated using only those patients who were using medication at the time of the outcome measurement). Effect on the score of different outcomes measured at year 2, 3 and 4. 'QUIP any' is a binary indicator of whether any of the behaviours in the QUIP questionnaire is present, while 'QUIP sum' refers to the total number of behaviours present (maximum of 8)."}
plot_bootstrap(
  full_results_PDMEDYN_started %>% process_results_aux,
  bs_pdmedyn_started %>% process_results_aux
)
```

## Figure 6S. Dyskinesias, motor fluctuations, QUIP – Any PD medication - Whole population

```{r fig.asp=0.4, fig.width=9, fig.cap="Figure 6S: Effect of a year of PD treatment (any medication)  during the first two years of follow-up (extrapolated to the whole study population). Effect on the score of different outcomes measured at year 2, 3 and 4.  'QUIP any' is a binary indicator of whether any of the behaviours in the QUIP questionnaire is present, while 'QUIP sum' refers to the total number of behaviours present (maximum of 8)."}
plot_bootstrap(
  full_results_PDMEDYN_extra %>% process_results_aux,
  bs_pdmedyn_extra %>% process_results_aux
)
```

## Figure 7S. Dyskinesias, motor fluctuations, QUIP – Only levodopa - Only starters
```{r fig.asp=0.4, fig.width=9, fig.cap="Figure 7S: Effect of a year of PD treatment (exclusively levodopa) during the first two years of follow-up (estimated using only those patients who used levodopa exclusively during the first two years). Effect on the score of different outcomes measured at year 2, 3 and 4.  'QUIP any' is a binary indicator of whether any of the behaviours in the QUIP questionnaire is present, while 'QUIP sum' refers to the total number of behaviours present (maximum of 8)."}
plot_bootstrap(
  full_results_onldopa_levoonly %>% process_results_aux,
  bs_onldopa_levoonly %>% process_results_aux
)
```


# Non-linearity of the effect
In the results above we assumed in the marginal structural model that the effect of treatment was linear: adding half a year of treatment has the same effect regardless of whether one goes from 0 years of treatment to 0.5 year of treatment or from 1.5 years of treatment to 2 years of treatment. Here we estimate how the effect differs for different time points. "Treatment @ 2" refers to having treatment at year 2 (so in the final six months), Treatment 1.5 is between year 1 and 1.5, etc.



```{r}
process_results <- function(.x) {
  .x %>% 
    filter(term %in% c("treatment","treatment_lag1","treatment_lag2","treatment_lag3")) %>% 
    filter(Model %in% c("IPW_msms_adj")) %>% 
    mutate(Model=term) %>% 
    filter(Outcome!="QUIP") %>% 
    filter(Outcome!="MDS_UPDRS_III_other") %>% 
    mutate(Outcome=str_replace_all(Outcome,"_"," ")) %>% 
    mutate(Outcome=str_replace_all(Outcome,"off","")) %>% 
    mutate(Outcome=str_replace_all(Outcome,"MDS UPDRS","MDS-UPDRS")) %>%
    mutate(Model=recode(Model,!!!c(`treatment`="Treatment @ 2",`treatment_lag1`="Treatment @ 1.5",
                                `treatment_lag2`="Treatment @ 1", `treatment_lag3`="Treatment @ 0.5"))) 
}
```

## Figure 8S. Non-linearity of the effect – IPTW – Only starters
```{r fig.asp=0.4, fig.cap="Figure 8S: Additive effect of treatment (any medication) being active at different time-points during the first two years for the IPTW model for only those patients who had started medication treatment at the time of the outcome measurement (hence, for the outcome at year 2, all included patients have active treatment at year 2). Effect on the score of different outcomes measured at year 2, 3 and 4."}
plot_bootstrap(
  full_results_PDMEDYN_started %>% process_results,
  bs_pdmedyn_started %>% process_results
)
```

## Figure 9S. Non-linearity of the effect – g-formula – Only starters
```{r fig.asp=0.4, fig.cap="Figure 9S: Additive effect of treatment (any medication)  being active at different time-points during the first two years for the g-formula model  (estimated using those patients who had started medication treatment at the time of the outcome measurement). Effect on the score of different outcomes measured at year 2, 3 and 4."}
process_results <- function(.x) {
  .x %>% 
    filter(term %in% c("treatment","treatment_lag1","treatment_lag2","treatment_lag3")) %>% 
    filter(Model %in% c("gformula_msms_adj")) %>% 
    mutate(Model=term) %>% 
    filter(Outcome!="QUIP") %>% 
    filter(Outcome!="MDS_UPDRS_III_other") %>% 
    mutate(Outcome=str_replace_all(Outcome,"_"," ")) %>% 
    mutate(Outcome=str_replace_all(Outcome,"off","")) %>% 
    mutate(Outcome=str_replace_all(Outcome,"MDS UPDRS","MDS-UPDRS")) %>%
    mutate(Outcome=str_replace(Outcome,"_other","")) %>% 
    mutate(Model=recode(Model,!!!c(`treatment`="Treatment @ 2",`treatment_lag1`="Treatment @ 1.5",
                                `treatment_lag2`="Treatment @ 1", `treatment_lag3`="Treatment @ 0.5"))) 
}

plot_bootstrap(
  full_results_PDMEDYN_started %>% process_results,
  bs_pdmedyn_started %>% process_results
) + ggtitle(NULL,subtitle = NULL)
```


# Effect modification
To estimate the potential modification of the effect for different baseline characteristics of the patient, using the inverse probability of treatment weights for each outcome/year we estimate a working marginal structural model containing main effects and interaction terms of treatment length with age, sex, disease duration and three MDS-UPDRS subscores at baseline in a single model.

```{r fig.cap="Figure 10S: Interaction effects in the IPTW Marginal Structural Model (main effects not shown), of the length of PD treatment (any PD medication) in the first two years of follow-up, on MDS UPDRS Part I, II and III, after 2, 3 and 4 years of follow-up, estimated using patients who had started medication therapy at the time of the outcome measurement."}
process_results <- function(.x) {
  .x %>% 
    filter(Model=="IPW_msms_interaction") %>% 
  filter(form=="I((treatment + treatment_lag1 + treatment_lag2 +      treatment_lag3)/2) * (Age + Sex + Duration + MDS_UPDRS_I_lag4 +      MDS_UPDRS_II_lag4 + MDS_UPDRS_III_other_lag4)") %>% 
    filter(str_detect(term,":")) %>% 
    mutate(term=str_replace(term,coll("I((treatment + treatment_lag1 + treatment_lag2 + treatment_lag3)/2):"),"Length*")) %>% 
    mutate(Model=term) %>% 
    filter(Outcome!="MDS_UPDRS_III_other") %>% 
    mutate(Outcome=str_replace_all(Outcome,"_"," ")) %>% 
    mutate(Outcome=str_replace_all(Outcome,"off","")) %>% 
    mutate(Outcome=str_replace_all(Outcome,"MDS UPDRS","MDS-UPDRS")) %>% 
    mutate(Model=recode(Model, !!!c(`Length*SexMale`="Length*Man",
                                    `Length*MDS_UPDRS_I_lag4`="Length*Part1",
                                    `Length*MDS_UPDRS_II_lag4`="Length*Part2",
                                    `Length*MDS_UPDRS_III_other_lag4`="Length*Part3")))
    
}


plot_table <- function(df_res, df_boot) {
  df_res %>% 
    left_join(df_boot,by = c("Outcome", "Model", "Year", "form")) %>% 
    filter(Year==2)
}

plot_bootstrap <- function(df_res, df_boot) {

  df_res %>% 
    left_join(df_boot,by = c("Outcome", "Model", "Year","form")) %>% 
    mutate(Model=(fct_inorder(Model))) %>% 
    ggplot(aes(x=estimate,y=fct_rev(Year),color=Model)) +
    geom_vline(aes(xintercept=0))+
    geom_point(na.rm=TRUE) +
    geom_segment(aes(x=estimate-2*sd,xend=estimate+2*sd,yend=Year),alpha=0.6,na.rm=TRUE) +
    theme_bw() +
    theme(text=element_text(family="sans"), 
          legend.position="none",
          panel.grid.major = element_line(linetype = 2,size=0.2),
          strip.background = element_rect(fill="white")) +
    ylab("") +xlab("") +
    facet_grid(Outcome~Model,labeller = labeller(Year = label_both, Outcome = label_value), scales="free_x") +
    theme(strip.placement = "outside",text=element_text(family="Lato")) +
    NULL#coord_cartesian(xlim=c(-10,10))
}

plot_bootstrap(
  full_results_PDMEDYN_started %>% process_results,
  bs_pdmedyn_started %>% process_results
)
```

# Treatment Probability Weights

An important assumption for the causal effect of interest to be identified is the positivity assumption of the different treatments: for each treatment decision, both starting treatment and non-treatment have to have a positive probability of occuring, for all strata in the population of interest. Apart from identifiability issues, small treatment probabilities can also cause estimation issues in inverse probability weighting, since they lead to some observations receiving large weights. For our main analysis (MDS UPDRS part III, measured at year 2), we report the distribution of the estimated probability of the assigned treatment, estimated probability of non-censoring, and the final stabilized weight used in our working marginal structural model. The bi-modal distribution in the propensity scores for treatment seems to be caused by the changing prior of starting treatment for the different time points. Because of the use of stabilized weights (where we multiply by the prior probability of the observed treatment assignment), the stabilized inverse probability weights do not show this strong bi-modality.

```{r fig.cap="Figure 11S: Estimated probabilities of observed treatment and non-censoring for the IPTW model for MDS-UPDRS Part III Off scores at year 2 (estimated using only those patients who were using medication at the time of the outcome measurement)."}
load("data/sensitivity.RData")

df_w <- res_markov_y2 %>% filter(outcome=="MDS_UPDRS_III_off_year2", modelname=="msms_adj") %>% .$globalfit %>% .[[1]] %>% attr("df_weights")

df_w %>% 
  group_by(id) %>% 
  mutate(w=exp(slpw)) %>% 
  select(id,treatment,w) %>% 
  mutate(treatment=ifelse(treatment=="censored","Censoring","Treatment")) %>% 
  mutate(treatment=fct_inorder(treatment)) %>% 
  #count(!is.na(weight))
  ggplot(aes(x=w)) +
  geom_histogram(bins=50) +
  facet_grid(~treatment) +
  theme_minimal() +
  xlab("Estimated Probability of Observed Treatment Assignment") +
  ylab("Number of observations") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  coord_cartesian(xlim=c(0,1)) +
  theme(text=element_text(family="Lato"))
```


```{r fig.cap="Figure 12S: Estimated stabilized inverse probability weights for the IPTW model for MDS-UPDRS Part III Off scores at year 2 (estimated using only those patients who were using medication at the time of the outcome measurement)."}
df_w %>% group_by(id) %>% 
              summarize(w=exp(sum(logweight))) %>% 
              ungroup %>% 
  ggplot(aes(x=w)) +
  geom_histogram(bins=50) +
  theme_minimal() +
  xlab("Stabilized Inverse Probability of Treatment Weight") +
  ylab("Number of observations") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  theme(text=element_text(family="Lato"))

```

# Sensitivity to alternative model specifications

Constructing models of complex disease and decision processes using limited data requires trade-offs in bias and variance of the model estimates. In the main analyses, we have focused on simple linear logistic and linear regression models, using a limited history of measurements (usually constrained to the previous measurements and constant patient characteristics, rather than a longer measurement history). Here we investigate the effect of making different choices in the probability of treatment modelling.

We report the results of the IPTW estimates at year 2 when taking only the previous measurement into account (as in our main results, denoted here as "Markov" to reflect the Markov assumption), when taking full measurement history into account while still using linear logistic regression models (denoted as "Non-Markov"), as well as when using this full history for a non-parametric model, in this case a random forest classifier (denoted as "Non-parametric"). For the random forest classifier, we make use of R's "randomForest" package, using the default settings, without cross-validation: 500 trees, a minimum node size 1, and the square root of the number of variables as the number of variables considered at each split. These defaults are also used in the "SuperLearner" implementation that we discuss in the next section. 

The results show the increased variance caused by the larger number of features in the unregularized models. The non-parametric models lead to similar point estimates as our main analysis. We do not report the estimated confidence interval for these models, as these would likely be an underestimate of the true uncertainty.

```{r}
load("data/sensitivity.RData")

change_names <- function(df) { df %>% 
      separate(outcome,c("Outcome","Year"),sep = "_year") %>% unite("Model", modelname) 
  }
  summ_stats <- function(df) { df %>% group_by(Outcome,Model,Year,form,term) %>%
    summarize(est=mean(estimate,na.rm=TRUE),sd=sd(estimate,na.rm=TRUE),n=n()) %>% ungroup }

make_compact <- function(x) {
  x %>% select(-msm) %>%
      mutate(ti=map(fitted,tidy,quick=TRUE)) %>%
      mutate(obs=map_int(fitted,function(x){nrow(x$model)})) %>% 
      select(-fitted,-globalfit) %>% unnest(cols = c(ti))
}

res_all <- bind_rows(
  res_markov_y2  %>% make_compact() %>% change_names() %>%  mutate(method="Markov"),
  res_nonmarkov_y2  %>% make_compact() %>% change_names() %>%  mutate(method="Non-Markov"),
  res_np_rf_y2  %>% make_compact() %>% change_names() %>%  mutate(method="Non-parametric"),
  res_markov_y3  %>% make_compact() %>% change_names() %>%  mutate(method="Markov"),
  res_nonmarkov_y3  %>% make_compact() %>% change_names() %>%  mutate(method="Non-Markov"),
  res_np_rf_y3  %>% make_compact() %>% change_names() %>%  mutate(method="Non-parametric"),
  res_markov_y4  %>% make_compact() %>% change_names() %>%  mutate(method="Markov"),
  res_nonmarkov_y4  %>% make_compact() %>% change_names() %>%  mutate(method="Non-Markov"),
  res_np_rf_y4  %>% make_compact() %>% change_names() %>%  mutate(method="Non-parametric"),
)  

bs_all <- bind_rows(
  bs_results_markov_y2 %>% change_names %>% summ_stats %>% mutate(method="Markov"),
  bs_results_nonmarkov_y2 %>% change_names %>% summ_stats %>% mutate(method="Non-Markov"),
  #bs_results_np_rf_y2 %>% change_names %>% summ_stats %>% mutate(method="Non-parametric"),
  bs_results_markov_y3 %>% change_names %>% summ_stats %>% mutate(method="Markov"),
  bs_results_nonmarkov_y3 %>% change_names %>% summ_stats %>% mutate(method="Non-Markov"),
  #bs_results_np_rf_y3 %>% change_names %>% summ_stats %>% mutate(method="Non-parametric"),
  bs_results_markov_y4 %>% change_names %>% summ_stats %>% mutate(method="Markov"),
  bs_results_nonmarkov_y4 %>% change_names %>% summ_stats %>% mutate(method="Non-Markov"),
  #bs_results_np_rf_y4 %>% change_names %>% summ_stats %>% mutate(method="Non-parametric")
)
```

```{r}
plot_bootstrap <- function(df_res, df_boot) {
  df_res %>% 
    left_join(df_boot,by = c("Outcome", "Year", "form","method")) %>% 
    mutate(method=fct_rev(fct_inorder(method))) %>% 
    ggplot(aes(x=estimate,y=method)) +
    geom_vline(aes(xintercept=0))+
    geom_point(na.rm=TRUE) +
    geom_segment(aes(x=estimate-2*sd,xend=estimate+2*sd,yend=method),alpha=0.6,na.rm=TRUE) +
    theme_bw() +
    theme(text=element_text(family="sans"), 
          legend.position="none",
          panel.grid.major = element_line(linetype = 2,size=0.2),
          strip.background = element_rect(fill="white")) +
    ylab("") +xlab("") +
    facet_grid(Year~Outcome,labeller = labeller(Year = label_both, Outcome = label_value), scales="free_x") +
    theme(strip.placement = "outside",text=element_text(family="Lato")) +
    NULL#coord_cartesian(xlim=c(-10,10))
}
```


```{r}
process_results <- function(.x) {
  .x %>% 
    filter(term %in% c("I((treatment + treatment_lag1 + treatment_lag2 + treatment_lag3)/2)",
                       "I((treatment_lag1 + treatment_lag2 + treatment_lag3) * 2/3)")) %>% 
    #filter(str_detect(Outcome,"MDS_UPDRS")|Outcome=="MoCA"|Outcome=="MSEADLG") %>% 
    filter(Outcome!="MDS_UPDRS_III_other") %>% 
    mutate(Outcome=str_replace(Outcome,"_off","")) %>% 
    mutate(Outcome=str_replace_all(Outcome,"_"," ")) %>% 
    mutate(Outcome=str_replace_all(Outcome,"MDS UPDRS","MDS-UPDRS"))
}
```

```{r fig.asp=0.35, fig.width=9, fig.cap="Figure 13S: Effect of a year of PD treatment (any medication) during the first two years of follow-up on outcomes at year 2 (estimated using only those patients who were using medication at the time of the outcome measurement) using the IPTW estimator and different propensity score models."}
plot_bootstrap(
  res_all %>% process_results,
  bs_all %>% process_results
)
```


# Targeted Maximum Likelihood Estimation

In our main analysis, we report on the performance of linear working MSMs with inverse probability weighting, as well as estimates using the parametric g-formula, and interpret the combination of their resulting estimates. An alternative is to combine these approaches into a single doubly robust estimate, with the guarantee that if either the probability of treatment model or the disease progression model (or both) is correctly specified, the combined estimator is a consistent estimator for the causal effect of interest. One elegant and efficient procedure to do this is targeted maximum likelihood estimation (van der Laan, M. J. (2010). Targeted maximum likelihood based causal inference: Part I. The international journal of biostatistics, 6(2).). We have attempted to apply this method to our problem by using the ltmle R package (Lendle, S. D., Schwab, J., Petersen, M. L., & van der Laan, M. J. (2017). ltmle: an R package implementing targeted minimum loss-based estimation for longitudinal data. Journal of Statistical Software, 81(1), 1-21.). While this package covers a large number of modelling scenarios, it does not exactly map on to the problem setup we used in our main analyses, which makes it challenging to directly compare the results. Most importantly, the package uses logistic regression models on transformed outcomes (where outcomes are mapped to be in [0,1]) as the working MSM. While being an interesting modelling choice, the  coefficients in these models do not directly correspond to the coefficients of the linear working MSM that we report in the main analyses. 

The figure below shows the results of the estimates using the ltmle package for MDS UPDRS Part III off scores at the end of year 2, in a working MSM that includes the baseline MDS UPDRS Part III scores. The propensity score and "Q" models include all previous measurements of the covariates (described as the "Non-Markov" setting in the previous section). We use both logistic regression for these models (results shown at the top of the figure) as well as a combination of logistic regression, Bayesian logistic regression and random forest models, that are combined using the SuperLearner package (see Van der Laan, M. J., Polley, E. C., & Hubbard, A. E. (2007). Super learner. Statistical applications in genetics and molecular biology, 6(1). and Polley, E., LeDell, E., Kennedy, C., Lendle, S., & van der Laan, M. (2019). Package ‘SuperLearner’.  https://CRAN.R-project.org/package=SuperLearner). For the SuperLearner model, Table 3S shows the contribution of the different models to the propensity score estimates at the different time points.

```{r fig.asp=1, fig.width=3, fig.cap="Figure 14S: Effect estimate of PD treatment (any medication) during the first two years of follow-up on outcomes at year 2 (estimated using only those patients who were using medication at the time of the outcome measurement) on MDS UPDRS Part III using the ltmle package for estimation. Note that the working MSM is a logistic regression model on the scaled outcomes, and the estimated beta is the parameter in this model, not the slope in the linear MSM used in the main analysis."}
load("data/sensitivity_tmle.RData")
df_glm <- res_glm %>% 
  data.frame %>% 
  gather("Method","Estimate") %>% 
  left_join(
    bs_glm %>% 
      gather("Method","Estimate",-rep) %>% 
      group_by(Method) %>% 
      summarize(sd=sd(Estimate)),
  by="Method") %>% mutate(Model="Logistic Regression")

df_sl <- res_sl %>% 
  data.frame %>% 
  gather("Method","Estimate") %>% 
  # left_join(
  #   bs_sl %>%
  #     gather("Method","Estimate",-rep) %>%
  #     group_by(Method) %>%
  #     summarize(sd=sd(Estimate)),
  # by="Method") %>%
mutate(Model="SuperLearner")

bind_rows(df_glm,df_sl) %>% 
  mutate(Method= fct_collapse(fct_rev(fct_relevel(Method,"iptw","gform","tmle")), "IPTW"="iptw", gformula="gform","TMLE"="tmle")) %>% 
  ggplot(aes(x=Estimate,y=Method,color=Method)) +
  geom_point() +
  geom_errorbarh(aes(xmin=Estimate-2*sd,xmax=Estimate+2*sd,y=Method),height=0,na.rm = TRUE) +
  facet_wrap(Model~.,ncol=1) +
  geom_vline(xintercept=0) +
  theme_bw() +
    theme(legend.position="none",
          panel.grid.major = element_line(linetype = 2,size=0.2),
          panel.grid.minor = element_line(linetype = 2,size=0.2),
          strip.background = element_rect(fill="white"),
          text=element_text(family="Lato")
          ) +xlab("beta")+ylab("")

```

```{r}
tb <- attr(res_sl,"tmle")$fit$g[[1]] %>% 
  as.data.frame() %>% select(contains("Coef")) %>% 
  t

rownames(tb) <- c("Treatment @ 0.5y", "Treatment @ 1y",
            "Treatment @ 1.5y", "Outcome Censored")
colnames(tb) <- c("GLM","Random Forest","BayesGLM")

tb %>% 
  kable(caption="Table 3S: Weights of the different base models in the SuperLearner model for the propensity scores",digits = 2)
```


```{r eval=FALSE}
# Example effect size
params <- c(-1.4287262,-0.3324097,0.0621267)
f <- function(x) { sum(params * c(1,x,21.1))}
pr <- function(x) {59*exp(f(x))/(1+exp(f(x)))}
pr(1.5)-pr(0.5)
```


